{% extends "base.html" %}
{% from "macros.html" import render_item, render_status, render_tag, patch_row_tiny %}

{% block breadcrumb %}
<li>{{ g.project.name }}</li>
{% endblock %}

{% block content %}

<div class="panel panel-primary">
    <div class="panel-heading">Project details</div>
    <div class="panel-body">
    <table class="table">
    <tbody>
        <tr>
        <th>Name</th> <td>{{ g.project.name }}</td>
        </tr>
        <tr>
        <th>List address</th>
        <td>{{ g.project.listemail }}</td>
        </tr>
        <tr>
        <th>Maintainers</th>
        <td>
            <ul class="list-inline">
            {%- for m in g.project.maintainers %}
                <li>
                    <a href="{{ url_for('profile', user_name=m.name) }}">
                        {{ m.name }}</a>&nbsp;
                    <a href="mailto:{{ m.email }}">
                        <span class="glyphicon glyphicon-envelope"></span>
                    </a>
                </li>
            {% endfor %}
            </ul>
        </td>
        </tr>
        <tr>
            <th>Patch count</th>
            <td>
            {{ render_status(g.project) }}
            </td>
        </tr>
        <tr>
            <th>Tags</th>
            <td>
                <a href="#" data-toggle="collapse" data-target="#taglist">
                {{ g.project.tags.count() }}
                </a>
            </td>
        <tr>
            <td colspan=2>
                <div class="collapse" id="taglist">
                    {% for tag in g.project.tags %}
                        {{render_tag(tag, g.project)}}
                    {% endfor %}
                </div>
            </td>
        </tr>

        {{ render_item("Website", g.project.web_url) }}
        {{ render_item("Source Code Web Interface",  g.project.webscm_url) }}
        {{ render_item("Source Code Manager URL", g.project.scm_url) }}
        </tr>
    </tbody>
    </table>
    </div>
</div>

{%- macro patch_panel(highlight, heading, group, page) -%}
    {% set patches = g.project[group+"_patches"].order_by("Patch.date desc") %}
    {%- if patches.count() -%}
    <div class="panel panel-{{highlight}}">
        <div class="panel-heading">{{heading}}</div>
        <table class="table table-striped">
        <thead>
            <tr><td colspan="4"><a href="javascript:$('.patch-checkbox').prop('checked', true);">select all</a> - <a href="javascript:$('.patch-checkbox').prop('checked', false);">clear</a> -
                <select id="states" name="new_state">
                    <option value='' ></option>
                    <option value='U' >unreviewed</option>
                    <option value="C" >commented</option>
                    <option value="A" >accepted</option>
                    <option value="R" >rejected</option>
                </select>
                <a href="#" id="bulk_apply">apply</a>
            </td></tr>
            <tr>
                <th></th>
                <th>Patch</th>
                <th>Date</th>
                <th>State</th>
            </tr>
        </thead>
        <tbody>
        {%- for patch in patches[:page] %}
            {{ patch_row_tiny(patch) }}
        {% endfor %}
        {% if patches.count() > page %}
        <tfoot>
            <tr><th colspan="0">
            <a
               href="{{ url_for("project.patches", group=group) }}">
               more...
            <a/>
            </th></tr>
        </div>
        {% endif %}
        </tbody>
        </table>
    </div>
    {% endif %}
    <script>
        $("#bulk_apply").click(function() {
            var selected=$('.patch-checkbox').filter(function(i){return $('.patch-checkbox')[i].checked;});
            var values=$.map(selected, function(el, i){return el.value;});
            var newState = $( "#states option:selected" )[0].value;
            if (values.length > 0 && newState.length > 0) {
                var valuesStr = values.join(',');
                $('<form action="bulk_change_state" method="POST">' +
                    '<input type="hidden" name="patches" value="' + valuesStr + '">' +
                    '<input type="hidden" name="new_state" value="' + newState + '">' +
                    '</form>').submit();
            }
        });
    </script>
{% endmacro %}

{{ patch_panel('danger', "Stale Patches", "stale", 10) }}
{{ patch_panel('info', "New Patches", "new", 10) }}

{% endblock %}
